import bag from './bag.png'
import test3D from './3d-test.png'

<div>

3D modeling is hard, but 3D modeling in Javascript is even _harder_. Javascript is easy and effective for many problems you need to tackle in your web apps; but when it comes to processing & displaying 3D models, it seems like it doesn't have the best set of tools.

Thankfully, there's a very good API for creating/displaying 3D models, which is [three.js](https://threejs.org/). I'm not gonna talk about three.js in general today, but I'm gonna explain how I used three.js to engrave a 3D model with a small hack, but with great success.

---

I'm freelancing for a couple of big fashion firms at the moment. A few weeks ago, I took this project of customizing (i.e. putting custom engravings on) 3D objects on web in real-time. We were already doing 2D engravings, but 3D was a whole new field. At first I didn't think it was feasible, at least in real-time. But after lots of trials and errors with a 3D designer friend, we found a really good solution.

We first thought we could dynamically change the texture file and re-apply it on the object to engrave whichever place we want on the object. It sounds like a good and feasible solution, and it might be feasible for some cases, but in our case it was not. The issue is, since the objects we're going to engrave are complex and not identical (they're basically built by putting together a bunch of images or a video of the product we got from the studio), texture files are entirely different. To achieve what we wanted, we needed to find the coordinates/angles/etc. of the engraving area for each product, so it wasn't really feasible.

Another possible solution was creating a mesh of our engraving dynamically and putting that on the object. But it was really hard to do, again, since the objects were really complex and not identical. We couldn't possibly find the place to put that mesh dynamically, and even if we did, we could _never_ place it perfectly on those complex surfaces.

Our clever solution was adding an empty mesh on each 3D model that covers the entire engraving area, and later on replacing that using three.js with the dynamically-created mesh that contains our engraving. This way we didn't need to know anything about the texture file nor the object file in Javascript.

## Object and Font Preparation

First step is super simple: using any 3D software (e.g. Blender, 3ds Max), just put an empty mesh that covers the whole surface of your engraving area. Later on, we will create a dynamic mesh that contains our engraving using three.js and replace that mesh.

<img src={bag} alt="" style={{ marginBottom: '1.5rem' }} />

An optional step is _font preparation_. If you're using images for each letter in your 2D engravings (just like us) because you want to have textures/gradients etc. in your letters, sadly you'll need to have an actual font file instead of images. You should turn those images into a font using any software or online tool.

## Javascript Part


First step is to load the font file in CSS: (if you want to use a custom font)

```css
@font-face {
      font-family: "Engraving";
      src:  url("font.otf") format("opentype"),
            url("font.ttf") format("truetype");
      text-rendering: optimizeLegibility;
      font-feature-settings: "kern" 1;
      font-kerning: normal;
    }
```

Then create a basic scene in three.js. I'm skipping this since it's explained in the official docs & many other blogs.

After creating your scene; create a canvas for the engraving material, and create the engraving material:

```js
const textCanvas = document.querySelector('#text-canvas');
const engravedText = new THREE.Texture();
const engravingMaterial = new THREE.MeshPhongMaterial({
  map: engravedText,
  // set the material settings so that your engraving will look good
  // under different angles/lightings
  color: 0x969696,
  reflectivity: 1,
  shininess: 10,
  flatShading: true,
  fog: true,
  refractionRatio: 0.98,
  skinning: false,
  specular: 0x000000,
  depthFunc: 3,
  blendDst: 205,
  blendSrc: 204,
});
// make it transparent so the only visible thing is the engraving
engravingMaterial.transparent = true;
```

Load your model using three.js and replace the dummy material (which is the engraving area) with the engraving material we just created:

```js
new THREE.MTLLoader()
        .setPath('/')
        .load('obj.mtl', function (materials) {
          materials.preload();
          const manager = initLoadingManager();
          new THREE.OBJLoader(manager)
            .setMaterials(materials)
            .setPath('/')
            .load('obj.obj', function (object) {
              mainObject = object;
              // replace the dummy material with our custom engraving material
              mainObject.children[1].material = engravingMaterial;
              mainObject.children[1].material.needsUpdate = true;
              ...
            });
        });
```

Now everything is set. There are 3 steps to apply an engraving;
- Fill the `textCanvas` with your engraving text.
- Apply the canvas to the `engravedText` texture.
- Apply the `engravingMaterial` to the main object and re-render.

Simple enough. Here's how it looks like in code:

```js
function engraveText(text) {
  const context = textCanvas.getContext("2d");
  // clear the canvas
  textCanvas.width = textCanvas.width;
  context.clearRect(0,0,textCanvas.width,textCanvas.height);
  // put the engraving on the canvas
  context.font = "170px Engraving";
  context.fillStyle = "#d2c2af";
  context.textAlign = "center";
  context.textBaseline = "middle";
  context.fillText(text.toLocaleUpperCase(), textCanvas.scrollWidth / 2, textCanvas.scrollHeight / 2 - 10);
  // patch the canvas onto the 3d object
  engravedText.image = textCanvas;
  engravedText.needsUpdate = true;
  mainObject.children[1].material = engravingMaterial;
  mainObject.children[1].material.needsUpdate = true;
}
```

Voila. And you should see your text engraved on the object.

<img src={test3D} alt="" style={{ marginBottom: '1.5rem' }} />

You can let me know if you have any issues or questions using the comment box below.

</div>