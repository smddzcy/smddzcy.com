<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>smddzcy | yet another dev</title>
        <link>/</link>
        <description>yet another dev. software engineer, web enthusiast. shares articles, tutorials and his thoughts on various things.</description>
        <lastBuildDate>Tue, 14 May 2019 21:40:59 GMT</lastBuildDate>
        <docs>http://blogs.law.harvard.edu/tech/rss</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <item>
            <title><![CDATA[Installing & Configuring PHP7 w/ ZTS on OS X]]></title>
            <link>/posts/2016-01-05/installing-configuring-php7-zts-on-os-x</link>
            <guid>/posts/2016-01-05/installing-configuring-php7-zts-on-os-x</guid>
            <content:encoded><![CDATA[<div><div><p>There are two ways to build PHP. First way is the simplest and no-mess way, using <strong>Homebrew</strong> - or any equivalent <em>package manager</em> depending on your system. If you are not already familiar with package managers, I strongly suggest you to be.  They make lives easier for sure. The second way is the slow &amp; messy way; building it from scratch without any package manager. It may be slow and messy but actually, it gives you more options while building. This is my way of installing PHP on my servers, but on my personal computer; since I don’t have any deep specific requirements - and for simplicity too - I’ll be using and talking about the Homebrew way. I’ll publish a tutorial about this too, but now let’s start.</p><h2 id="installing">Installing</h2><p>First, update the Homebrew and get the required formulas - <em>formulas</em> are just packages, like those in aptitude. If you don’t have Homebrew yet, visit this page for installation and detailed usage: <a href="http://brew.sh">http://brew.sh</a></p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew update <span class="token operator">&amp;&amp;</span> brew tap homebrew/php
</code></pre><p>See which versions of PHP we can have.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew search php
</code></pre><p>There will be a long list. If you see something like &quot;<strong>homebrew/php/php70</strong>&quot; then it’s OK. Now let’s look at the options we have.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew options php70
</code></pre><p>You can use any of these options while installing PHP, but do not forget to include <code>--with-thread-safety</code>, it is essential for threading extensions. Now start the installation</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew <span class="token function">install</span> php70 --with-thread-safety --with-homebrew-curl
</code></pre><p>After some time - brace yourself, it might take a little long - depending on your internet and Mac’s speed, installation finishes. Now install some extensions. My recommendations are here but you can find all the extensions by <code>brew search php70-</code></p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew <span class="token function">install</span> php70-opcache php70-mcrypt php70-pthreads php70-xdebug --build-from-source
brew <span class="token function">install</span> php70-memcached --build-from-source --HEAD
</code></pre><p>Installation is done, let’s continue with configuration.</p><h2 id="configuring">Configuring</h2><p>I start by adding PHP support in Apache. First you have to find the path to your httpd.conf file: (mostly it’ll be <code>/private/etc/apache2/httpd.conf</code>)</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">httpd -V <span class="token operator">|</span> <span class="token function">grep</span> SERVER\_CONFIG\_FILE
</code></pre><p>Open the file with a text editor, also with privileges otherwise you can’t make changes - use <code>sudo</code> for example.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">sudo</span> <span class="token function">nano</span> PATH-TO-YOUR-CONFIG
</code></pre><p>Add these at the end of the file</p><pre><code>LoadModule php7_module /usr/local/opt/php70/libexec/apache2/libphp7.so

&lt;FilesMatch .php$&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;
</code></pre><p>Then find this line</p><pre><code>DirectoryIndex index.html
</code></pre><p>and change with:</p><pre><code>DirectoryIndex index.php index.html
</code></pre><p>You can close the config file. Now let’s set up the <code>php.ini</code>. First make a link to the new <code>php.ini</code> file</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">sudo</span> <span class="token function">mv</span> /etc/php.ini /etc/php.ini_old
<span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/etc/php/7.0/php.ini /etc/php.ini
</code></pre><p><code>/etc</code> is the path to my .ini file. You can see yours by running:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">php --ini
</code></pre><p>Then this file needs some configuration too. Find <code>;date.timezone =</code> and set your timezone. Mine is:</p><pre><code>date.timezone = &quot;Europe/Istanbul&quot;
</code></pre><p>Find <code>;opcache.enable</code>, <code>;opcache.enable_cli</code> and set them both to <code>1</code>, also delete the <code>;</code> (<em>semicolon</em>) prefixes. For detailed opcache settings, visit this page: <a href="https://www.scalingphpbook.com/best-zend-opcache-settings-tuning-config/">https://www.scalingphpbook.com/best-zend-opcache-settings-tuning-config/</a></p><p>There are tons of options in the <code>php.ini</code> and <code>httpd.conf</code>, I can’t include them all here but I suggest you to make some research and find the best options that suit your case. After these, it should be all set. Open a new terminal window, fire up your server and check the PHP version. You can also see your installed extensions by running <code>php -m</code>.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">sudo</span> httpd -k restart
php -v
</code></pre><img src="/static/media/php-7-version.65df2595.png" alt="php 7 version"/><p>My next post will be about using <strong>pThreads</strong>. If you have questions or recommendations about PHP 7, please let me know.</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Multi-Threading in PHP7 w/ pThreads]]></title>
            <link>/posts/2016-01-26/multi-threading-in-php7-pthreads</link>
            <guid>/posts/2016-01-26/multi-threading-in-php7-pthreads</guid>
            <content:encoded><![CDATA[<div><div><p>Almost a year ago, I came across with this <strong>pThreads</strong> extension. It’s an extension that makes it possible to create multi-threaded applications in PHP, and I completely fell in love with it! It is not some bullshit like forks; it gives you the ability to use real POSIX threads.</p><blockquote><p>Absolutely, this is not a hack, we <em>don’t</em> use forking or any other such nonsense, what you create are honest to goodness POSIX threads that are completely compatible with PHP and safe … this is true multi-threading :)</p></blockquote><p>As I said before, you’ll be amazed by its speed and easy-to-use structure. Let’s start.</p><h2 id="installing">Installing</h2><p>It’s a PECL extension. If you have PECL, you can install directly with it.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">pecl <span class="token function">install</span> pthreads
</code></pre><p>Or you can install via Homebrew on macOS.</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">brew <span class="token function">install</span> php70-pthreads
</code></pre><p>After installation, check the output of <code>php -m</code>. You probably won’t see pThreads there, which means you should add its extension declaration to your <code>php.ini</code> to enable it. You have to add something like <code>extension=&quot;PATH-TO-EXTENSION-FILE/pthreads.so or .dll&quot;</code> and restart your server. If your server fails to start - which is normal - look for the error it gives. It will say something like this for Apache:</p><pre><code>PHP Fatal error: The apache2handler SAPI is not supported by pthreads
PHP Fatal error: Unable to start pthreads module in Unknown on line 0 Unknown(0) : Fatal error - The apache2handler SAPI is not supported by pthreads Unknown(0) : Fatal error - Unable to start pthreads module
</code></pre><p>It’s because pThreads only works on the CLI side with the recent versions, and you have to disable it for your web server. Make a copy of your php.ini file in the same directory with the default one, name it <code>php-cli.ini</code>, then delete the <code>extension=&quot;PATH-TO-EXTENSION-FILE/pthreads.so or .dll&quot;</code> declaration from the default <code>php.ini</code> file. Try to start your server again; now there shouldn’t be any problem.</p><h2 id="usage">Usage</h2><p>Let’s look at this simple example.</p><pre><code class="language-php" data-language="php" data-highlighted-line-numbers=""><span class="token operator">&lt;</span>php

<span class="token keyword">class</span> <span class="token class-name">SomeThreadedClass</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token variable">$tID</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$data</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span>int <span class="token variable">$tID</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">tID</span> <span class="token operator">=</span> <span class="token variable">$tID</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">data</span> <span class="token operator">=</span> <span class="token variable">$tID</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">":"</span> <span class="token punctuation">.</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'H:i:s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">tID</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">" started.\n"</span><span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">tID</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">tID</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">" ended. "</span> <span class="token punctuation">.</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'H:i:s'</span><span class="token punctuation">)</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$threads</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SomeThreadedClass</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// start the job on the background</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// wait until job is finished, </span>
    <span class="token keyword">echo</span> <span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">data</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span> <span class="token comment">// then we can access the data</span>
<span class="token punctuation">}</span>
</code></pre><p>Create a class that extends <code>Thread</code>, and override the <code>run</code> method. It’s simply all it takes to get a threaded PHP object.</p><pre><code class="language-php" data-language="php" data-highlighted-line-numbers=""><span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>This line, the start method, initiates the thread and starts executing your object’s run method.</p><pre><code class="language-php" data-language="php" data-highlighted-line-numbers=""><span class="token variable">$threads</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>When your thread finishes its task, you can reach to your object after calling the join method. Output of the code above:</p><pre><code>1 started.
2 started.
3 started.
4 started.
1 ended. 18:18:52
1:18:18:51
2 ended. 18:18:53
2:18:18:51
3 ended. 18:18:54
3:18:18:51
4 ended. 18:18:55
4:18:18:51
</code></pre><p>It looks totally satisfying, doesn’t it ? I suggest you to take a look at its documentation &amp; great examples on its <a href="https://github.com/krakjoe/pthreads">GitHub page</a>. There is also a php.net documentation: <a href="http://php.net/manual/en/book.pthreads.php">http://php.net/manual/en/book.pthreads.php</a></p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Lambda Expressions in Java 8]]></title>
            <link>/posts/2016-05-15/lambdas-in-java-8</link>
            <guid>/posts/2016-05-15/lambdas-in-java-8</guid>
            <content:encoded><![CDATA[<div><div><p>Although I don’t prefer Java as my day-to-day language - mostly because of the sizes of my projects, it is a language that I really like programming in. A single Java code can run on almost all types of machines, the syntax is great, it is full OOP - something I really like, it has so many quality libraries to chose from and the list goes on. It has its bad parts, too. The major problem that affects my preference about Java, I think most of you out there will agree with me, is verbosity. But a big step was taken in Java 8 to a more functional &amp; less verbose programming language. One of the most important features of Java 8 is <em>lambda expressions</em>.</p><h2 id="example">Example</h2><p>Creating a Comparator before Java 8 was like this:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> beforeJava8 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> o1<span class="token punctuation">,</span> <span class="token class-name">Integer</span> o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> o1 <span class="token operator">-</span> o2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>With Java 8, it’s like this:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> withJava8 <span class="token operator">=</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-></span> o1 <span class="token operator">-</span> o2<span class="token punctuation">;</span>
</code></pre><p>Right part of the expression above, <code>(o1, o2) -&gt; o1 - o2</code>  is a <em>lambda expression</em>. It takes <code>o1</code>, <code>o2</code>  as parameters of the <code>compare</code> method of <code>Comparator</code>, and returns <code>o1 - o2</code> . <code>-&gt;</code>  is the separator - called <em>lambda operator</em>, of the lambda expression. It separates <strong>parameters</strong> from the <strong>body</strong> of the lambda expression. In a lambda expression, we don’t have to declare the types explicitly. Java can determine the types from the context. Since the type we declared as arguments of Comparator is Integer , Java can infer the types of <code>o1</code> and <code>o2</code> as <code>Integer</code>. But if we remove the type from the Comparator declaration and write something like this, <strong>code will not compile</strong> since Java can’t infer the types.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Comparator</span> withJava8 <span class="token operator">=</span> <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-></span> o1 <span class="token operator">-</span> o2<span class="token punctuation">;</span> <span class="token comment">// fails to compile</span>
</code></pre><p>By the way, lambdas are not just fancy anonymous classes. They separate themselves from anonymous classes in the lower levels of Java. Some of the differences between them are listed below.</p><ul><li>Lambdas are not implemented using anonymous classes; meaning they don’t take space in the disk as .class  files and it speeds up the start time of JVM.</li><li>Types used in lambdas are not explicit, they are determined from the context.</li><li>Variables cannot be shadowed in a lambda expression. If attempted, it gives a compile time error.</li><li><code>this</code> refers to the class that uses the lambda expression. On anonymous classes, it refers to anonymous class itself.</li></ul><h2 id="how-it-works">How it works</h2><p>If we look at the declaration of Comparator interface, we see a new annotation.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token annotation punctuation">@FunctionalInterface</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Comparator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
</code></pre><p><em><strong>Lambdas can only be used on functional interfaces, which has exactly one abstract method. </strong>(Default methods aren’t counted as abstract)</em> <code>@FunctionalInterface</code> annotation is not something that functional interfaces <em>must</em> have, but it’s a good sign both for us and the Java to understand that an interface is a functional interface. Do we have to write all of the functional interfaces we’re going to use ? Of course not. Java 8 comes with a great number of functional interfaces, located in <code>java.util.function</code> package.</p><h3 id="javautilfunctionconsumer">java.util.function.Consumer</h3><p>Consumer interface performs an operation on an argument.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> consumer <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="javautilfunctionsupplier">java.util.function.Supplier</h3><p>Supplier interface takes no argument, but produces a result.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="javautilfunctionfunction">java.util.function.Function</h3><p>Function interface takes one argument, and produces a result.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> function <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="javautilfunctionpredicate">java.util.function.Predicate</h3><p>Predicate interface takes one argument, and returns the result of an evaluation on that argument.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> predicate <span class="token operator">=</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><p>Another great feature of Java 8 is <strong>Stream API</strong>, which will be covered on a later post. It provides a greater functionality to Java, and also it is a <em>perfect fit</em> for lambda expressions. Until then, <em>Valéte!</em></p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Streams in Java 8]]></title>
            <link>/posts/2016-06-03/streams-in-java-8</link>
            <guid>/posts/2016-06-03/streams-in-java-8</guid>
            <content:encoded><![CDATA[<div><div><p>Last time I’ve talked about <a href="/posts/2016-05-15/lambdas-in-java-8" title="Lambda Expressions in Java 8">Lambda Expressions in Java 8</a> and now it’s time to talk about <strong>streams</strong>.</p><p>Lambdas give us the ability to pass behavior by using functional interfaces, which removes the need for extra classes. They are already great; they make the code cleaner and more understandable, but they are greater if we make use of them while creating APIs. An example to such an API is the <strong>Stream API</strong> in <em>JDK 8</em>.</p><p>We use streams to construct a pipeline of operations on a <em>Collection</em>. Let’s take a look at a simple example.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">List</span> l <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"AB"</span><span class="token punctuation">,</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token string">"EFG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
l<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-></span> s<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token operator">-></span> s1<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s2<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ul><li><code>stream()</code>: Creates a stream pipeline on the given collection, which is a <code>List</code> in this case.</li><li><code>map(Function)</code>: Applies the given <code>Function</code> on all elements of this stream and returns a new stream. Lambda expression <code>s -&gt; s.toLowerCase()</code> creates a <code>Function</code> to convert all elements to lower-case.</li><li><code>filter(Predicate)</code>: Filters the stream by the given <code>Predicate</code> and returns a new stream. Lambda expression <code>s -&gt; s.contains(&quot;a&quot;)</code> creates a <code>Predicate</code> to filter all elements which contains <em>“a”</em>.</li><li><code>sorted(Comparator)</code>: Sorts all elements of this stream by the given <code>Comparator</code>. Lambda expression <code>(s1, s2) -&gt; s1.length() - s2.length()</code> creates a <code>Comparator</code> to sort all elements by their length in ascending order.</li><li><code>forEach(Consumer)</code>: Performs an action on all elements of this stream. This is a <strong>terminal operation</strong>, which means it doesn’t return a stream. Lambda expression <code>System.out::println</code> creates a <code>Consumer</code> to print all elements line-by-line. This is exactly the same with writing <code>s -&gt; System.out.println(s)</code>, just a shorter form.</li></ul><p>Stream operations can be performed sequentially or in parallel. <strong>One thing to keep in mind is that stream is not a data structure, it is just <em>higher level abstraction</em>.</strong> Streams do not store any data.</p><p>Streams are <strong>lazy</strong>, means they are only computed when accessed. <em>Intermediate operations</em> like <code>map(Function)</code>, <code>filter(Predicate)</code>, <code>sorted(Comparator)</code> actually <strong><em>does nothing</em></strong> until the stream is accessed by a <em>terminal operation</em>, ie. <code>forEach(Consumer)</code> operation on the example shown above. This allows us to produce infinite streams of data.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">IntStream</span> infiniteStream <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> el <span class="token operator">-></span> el <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>el <span class="token operator">-></span> el <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Code shown above creates an infinite integer stream, and filters the odd ones. One might expect that when we execute this code, it will cause an infinite loop, eventually fill the whole memory and then crash. But since the streams are <em>lazy</em> and only evaluated when accessed, this works just fine. <em>But</em>, if we add a terminal operation like this:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> infiniteStream <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> el <span class="token operator">-></span> el <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>el <span class="token operator">-></span> el <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                  <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>It <em>does</em> cause an infinite loop and the program eventually crashes with a beautiful exception: <code>Exception in thread &quot;main&quot; java.lang.OutOfMemoryError: Java heap space</code>.</p><p>By the way, there are so many readily accessible intermediate operations you can use and I simply can’t explain them all, but let me explain the ones I used above.</p><ul><li><code>boxed()</code>: Returns a new stream consisting all elements of this stream boxed to an <code>Integer</code>.</li><li><code>collect(Collector)</code>: Collects all elements of this stream by using the given <code>Collector</code>. The one used above collects this stream to a <code>List</code>.</li></ul><p>This was a simple &amp; quick guide and there is much more to learn. I strongly suggest you to dig into it and learn <em>creating streams from different data sources</em>, <em>parallel streams</em> etc. Next time I’ll be looking at <strong>interface default methods</strong>. Have a good day!</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Default Methods in Java 8]]></title>
            <link>/posts/2016-06-08/default-methods-java-8</link>
            <guid>/posts/2016-06-08/default-methods-java-8</guid>
            <content:encoded><![CDATA[<div><div><p>Last time I’ve talked about <a href="/posts/2016-06-03/streams-in-java-8">Streams in Java 8</a> and now it’s time to talk about <strong>interface default methods</strong>.</p><p>We all know that we should code to interfaces. Interfaces give the clients all they need, without giving any detail about its implementation at all. (Known as &quot;<a href="https://en.wikipedia.org/wiki/Loose_coupling">Loose coupling</a>&quot;) Because of this, designing clean and long-lasting interfaces is an important aspect of programming. But, what happens as our project &amp; implementations grow and we need to add new behaviors to those interfaces ? Well, <em>default methods</em> to rescue.</p><blockquote><p>Default methods enable you to add new functionality to the interfaces of your libraries and ensure binary compatibility with code written for older versions of those interfaces.</p></blockquote><p>That’s what Java says on its <a href="https://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html"><em>official documentation</em></a>. Default methods are the methods you can include in interfaces with their <em>implementation details</em>. Let’s continue with examples to understand it better.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Let’s say that you have this interface and there are millions of people out there using it and building on top of it. If default methods were not an option, when you add a new behavior, all of the classes built on top of it would have to implement this or <em>they wouldn’t work</em>. With default methods, <strong>you can easily expand your interfaces</strong>. Let’s add a new behavior to our interface, of course with its implementation.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"No message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "No message"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>That’s it. Nothing is broken and everybody enjoys their new feature. Also they can change the behavior of that method too by overriding it.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  
    <span class="token comment">// ...</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token string">"Name: "</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">" - Age: "</span> <span class="token operator">+</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Name: Bob - Age: 19"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h2 id="conflicts-with-multiple-interfaces">Conflicts with Multiple Interfaces</h2><p>Java always had <em>multiple inheritance of type</em>, but with Java 8 and default methods, now it has <strong><em>multiple inheritance of behavior</em></strong>. But along with all the goodness, that brings in some problems too.</p><h4 id="1-ambiguity-in-default-methods-with-same-signature">#1: Ambiguity in Default Methods with Same Signature</h4><p>Since classes can implement multiple interfaces, there could be a situation where 2 interfaces have a default method with the <em>same signature</em>. This causes a <strong><em>conflict</em></strong> and results in a compilation error since Java doesn’t know what to do.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"No message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Citizen message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>

<span class="token comment">// ...</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"Samed"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Compilation error</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre><code>Exception in thread &quot;main&quot; java.lang.Error: Unresolved compilation problem:
    Duplicate default methods named getMessage with the parameters () and () are inherited from the types Citizen and Person
</code></pre><p>We can fix this problem by overriding the method, then choosing one of the implementations or implement our own.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">Person</span><span class="token punctuation">,</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>

    <span class="token comment">// ...</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Citizen</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Choose Citizen's default method. Yes, "super" keyword is necessary.</span>
    <span class="token comment">// return Person.super.getMessage(); // Choose Person's default method</span>
    <span class="token comment">// return "Wow what a message"; // Or implement our own</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token string">"Samed"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Citizen message"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="2-more-specific-interface-problem">#2: More Specific Interface Problem</h4><p>In the case where an interface is more specific than the other, Java <em>automatically chooses</em> its default method and <strong>you can’t bypass that by choosing the less specific interface’s default method</strong>.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Citizen message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">TurkCitizen</span> <span class="token keyword">extends</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Turk citizen message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">TurkCitizen</span><span class="token punctuation">,</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "Turk citizen message"</span>
    <span class="token punctuation">}</span>
</code></pre><p>If you try to bypass this and choose <code>Citizen</code>s default method, that results in another beautiful <em>compilation error</em>.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">interface</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Citizen message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">TurkCitizen</span> <span class="token keyword">extends</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"Turk citizen message"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token keyword">implements</span> <span class="token class-name">TurkCitizen</span><span class="token punctuation">,</span> <span class="token class-name">Citizen</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Citizen</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterfaceDefaultMethods</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Student</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Compilation error</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><pre><code>Exception in thread &quot;main&quot; java.lang.Error: Unresolved compilation problem:
    Illegal reference to super type Citizen, cannot bypass the more specific direct super type Java8.TurkCitizen
</code></pre><p>That’s all. This was a simple &amp; quick guide and I hope you’ve enjoyed it. Next time I’ll be looking at <strong>optionals</strong>. Have a good day !</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Multithreading in Java]]></title>
            <link>/posts/2016-10-11/multithreading-in-java</link>
            <guid>/posts/2016-10-11/multithreading-in-java</guid>
            <content:encoded><![CDATA[<div><div><p>Today I’m going to talk a little bit about <strong>multithreading in Java</strong>.</p><p>A <em>thread</em> is a small component of a <em>process</em>, that can run concurrently with the other components (threads). It differs from a <em>process</em> in several ways but the most important thing is; <strong>threads share the same state, while processes are independent units</strong>. This means that all threads of a process share the same process state, memory space and resources.  </p><img src="/static/media/thread-figure.b296100c.png" alt="Threads of a process" style="max-width:320px;margin-top:2rem;margin-bottom:2rem"/><p>You can think of it as a worker, working in parallel with other workers. Let’s say that your house needs painting. If you hire 1 worker, it’d take him 10 hours to paint the entire house. But if you hire 5 workers, and if all of them work concurrently on different parts of the house, it’d take only 2 hours. Also, they share the same resources (paint) and the same space (house). This is just how the threads work.</p><h2 id="life-cycle-of-a-thread">Life Cycle of a Thread</h2><p>A thread’s lifecycle consists of different stages. For example; a thread <em>starts</em>, <em>waits</em> for another thread to perform a necessary task, <em>executes</em> its task, and <em>dies</em>. It can be in only one stage at a given time. The life cycle of a thread is controlled by JVM.</p><img src="data:image/png;base64,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" alt="Diagram - Life cycle of a thread"/><p>Here are the stages in detail:</p><ul><li><strong>New</strong>: A <em>born thread</em>. It is the stage before the program starts the thread.</li><li><strong>Runnable</strong>: After the program starts the thread, it becomes <em>runnable</em>. It means that it is executing its task in JVM.</li><li><strong>Non-Runnable (Blocked)</strong>: The thread is still alive, but it is not eligible to execute its task. It is currently waiting for an object’s monitor (for details: <a href="https://en.wikipedia.org/wiki/Mutual_exclusion">Mutual exclusion</a>). It mostly happens when the thread is waiting for access to synchronized code.</li><li><strong>Waiting</strong>: The thread is waiting for another thread to complete a task.</li><li><strong>Timed Waiting</strong>: The thread is waiting for another thread to complete a task, but up to a certain amount of time. It’ll go back to runnable stage when that time interval expires or the other thread completes its task.</li><li><strong>Terminated (Dead)</strong>: The thread has completed its task or it is terminated.</li></ul><p>Now, let’s get to our main subject: <em>multithreading</em>.</p><p>Multithreading is the process of running multiple threads of a process at the same time. Let me start by creation of a thread.</p><h2 id="creating-a-thread">Creating a Thread</h2><p>There are some useful methods of <code>Thread</code> class which we are going to use:</p><ul><li><code>start()</code>: Begins the execution, JVM calls the run() method of this thread.</li><li><code>join()</code> or <code>join(long millis)</code>: Waits for the thread to die. The one takes an argument waits for a maximum of millis milliseconds. (if 0, waits forever - same as join())</li><li><code>setPriority(int newPriority)</code>: Sets the priority of this thread.</li><li><code>getPriority()</code>: Returns the priority of this thread. setName(String name): Sets the name of this thread.</li><li><code>getName()</code>: Returns the name of this thread.</li><li><code>isAlive()</code>: Returns a boolean indicating if the thread is alive or not.</li><li><code>stop()</code>: Stops the thread. This method <em>currently</em> exists but <strong>don’t use it to stop threads</strong>, since it’s deprecated and its usage is not recommended. If you want to stop a thread, see <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/misc/threadPrimitiveDeprecation.html">Java docs</a>.</li></ul><h3 id="option-1-extending-the-thread-class">Option 1: Extending the Thread Class</h3><p>It is as simple as extending the Thread class and overriding the run method. Example:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is running."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Thread 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Output:</p><pre><code>Thread 1 is running.
Thread 2 is running.
</code></pre><h3 id="option-2-implementing-the-runnable-interface">Option 2: Implementing the Runnable Interface</h3><p>Actually, what we did above was just implementing the Runnable interface. It is also possible to explicitly implement that and create a Thread object with that implementation. The Thread class has a constructor which accepts a Runnable object. Example:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyWorker</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyWorker</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">" is running."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> worker1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWorker</span><span class="token punctuation">(</span><span class="token string">"Worker 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> worker2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWorker</span><span class="token punctuation">(</span><span class="token string">"Worker 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>worker1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>worker2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Output:</p><pre><code>Worker 1 is running.
Worker 2 is running.
</code></pre><p>There are also other ways to run these workers. One of them is creating a <em>thread pool</em>. I’m not getting into its details but here is a simple example with the same <code>MyWorker</code> class:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Runnable</span> worker1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWorker</span><span class="token punctuation">(</span><span class="token string">"Worker 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runnable</span> worker2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyWorker</span><span class="token punctuation">(</span><span class="token string">"Worker 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This creates a fixed size thread poll.</span>
    <span class="token comment">// You can also create a single thread executor with</span>
    <span class="token comment">// \`Executors.newSingleThreadExecutor()\` and an expandable</span>
    <span class="token comment">// thread pool with \`Executors.newCachedThreadPool()\`</span>
    <span class="token class-name">ExecutorService</span> e <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>worker1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>worker2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Previously submitted tasks will be executed,</span>
    <span class="token comment">// but no new tasks will be accepted after this.</span>
    e<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>See for details: <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/pools.html">https://docs.oracle.com/javase/tutorial/essential/concurrency/pools.html</a></p><h3 id="option-3-using-anonymous-class">Option 3: Using Anonymous Class</h3><p>It is the dirty way of creating a thread. Same as option 2, but just <em>dirtier</em>. Example:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread is executing its task."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">dummyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Thread is finished its task."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dummyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Test string"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Output:</p><pre><code>Test string
Thread is executing its task.
0 1 2 3 4 5 6 7 8 9 10
Thread is finished its task.
</code></pre><h2 id="thread-priority">Thread Priority</h2><p>We say that all threads run concurrently; but in reality, it is not the case. It feels like it is a concurrent environment, but your system cannot run all of your threads simultaneously. There is a <strong>thread scheduler</strong> in JVM that decides which thread to run, based on many factors including <em>priority</em>. Every thread in Java has a priority between <code>MIN_PRIORITY</code> and <code>MAX_PRIORITY</code>. If you don’t set it, its default is <code>NORM_PRIORITY</code>.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token comment">/**
 * The minimum priority that a thread can have.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MIN_PRIORITY <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The default priority that is assigned to a thread.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> NORM_PRIORITY <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The maximum priority that a thread can have.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> MAX_PRIORITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre><p>It <em>hopefully</em> determines the order of execution of the threads; however, <strong>it doesn’t guarantee it</strong>. As I’ve said, it’s just one of those <em>many factors</em>. Example of thread priority:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">dummyJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" is finished."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">dummyJob</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">+=</span> <span class="token string">"dummy"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> s<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Priority:1"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Priority:5"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token string">"Priority:10"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Output:</p><pre><code>Priority:10 is finished.
Priority:5 is finished.
Priority:1 is finished.
</code></pre><p>This is it for now. Next time I’ll get into the details of multithreading and talk about <strong>java.util.concurrent</strong> package. Have a great day!</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Thread Synchronization in Java - Monitors and Atomic Operations]]></title>
            <link>/posts/2017-01-22/thread-synchronization-java</link>
            <guid>/posts/2017-01-22/thread-synchronization-java</guid>
            <content:encoded><![CDATA[<div><div><p>Today I’m going to talk about <strong>thread synchronization</strong>. Let’s start with writing a simple multi-threaded counter.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CounterThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">CounterThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread:%s, counter:%d\\n"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CounterThread</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CounterThread</span><span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>We expect to see a nice incrementation of the count variable, sometimes by the thread 1 and sometimes by the thread 2. Here is the output this code produces:</p><pre><code>Thread:t2, counter:0
Thread:t1, counter:0
Thread:t1, counter:2
Thread:t1, counter:3
Thread:t1, counter:4
Thread:t1, counter:5
Thread:t2, counter:1
Thread:t2, counter:7
Thread:t2, counter:8
Thread:t2, counter:9
Thread:t1, counter:6
</code></pre><p>This is definitely not the outcome we expected. What is wrong with those first 2 lines? Thread <code>t2</code> increases the counter to 1, so the second line should’ve been <code>Thread:t1, counter:1</code>, right?</p><p><strong>NO</strong>.</p><p>In the example above, there is the possibility that both threads access the variable and increment it at the same time. It’s called <strong>race condition</strong>. Because the thread scheduling algorithm can swap between threads at any time; we don’t know the execution order of the threads, and we don’t know when they will try to access the shared data. The result is; multiple threads <em>racing</em> to access and change the data.</p><p>There are many ways to overcome this problem. Here I’ll provide you two of them that I use the most.</p><h3 id="monitors">Monitors</h3><p>In Java, synchronization is built around an internal entity of an object known as <em>intrinsic lock</em> or <em>monitor</em>. Every object has an intrinsic lock associated with it, and Java uses that to synchronize the object.</p><p>If you want to prevent your threads from accessing the shared data at the same time, you can simply use the builtin synchronized keyword.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CounterThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">CounterThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread:%s, counter:%d\\n"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>The lock object here acts as a physical lock. Whenever a thread accesses the synchronized code:</p><ul><li>If the lock is unlocked, Java automatically locks it and allows the thread to run the code. When the thread finishes its job, Java automatically unlocks the lock.</li><li>If it’s locked, thread just waits its turn.</li></ul><p>Here we used a simple <code>Object</code> as a lock, but Java provides more powerful locks in the <code>java.util.concurrent.locks</code> package. You can check them out if you want.</p><p>We can also use the <code>synchronized</code> keyword on the method itself, like this:</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token annotation punctuation">@Override</span>
<span class="token keyword">synchronized</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread:%s, counter:%d\\n"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>But, <strong>it won’t work</strong> with our case. Here is the output:</p><pre><code>Thread:t1, counter:0
Thread:t2, counter:0
Thread:t2, counter:2
Thread:t2, counter:3
Thread:t2, counter:4
Thread:t2, counter:5
Thread:t2, counter:6
Thread:t2, counter:7
Thread:t2, counter:8
Thread:t2, counter:9
Thread:t1, counter:1
</code></pre><p>If we synchronize the method, Java uses the object’s lock. But our threads have their own objects, and <strong>have their own locks</strong>. Here, they don’t really do anything but locking and unlocking two separate locks without knowing about each other. It becomes the same thing as using no locks at all. It only would’ve worked if the threads were trying to access the same object.</p><h3 id="atomic-operations-and-volatile-keyword">Atomic Operations and Volatile Keyword</h3><p>An operation is <em>atomic</em>, (or <em>linearizable</em>, <em>indivisible</em>, <em>uninterruptible</em>) if it appears to the rest of the system to occur instantaneously. An atomic operation cannot stop in the middle: <strong>it either happens completely, or it doesn’t happen at all</strong>. In other words, <a href="http://softwareengineering.stackexchange.com/questions/40297/what-is-a-side-effect">side effects</a> of an atomic operation are not visible until it finishes.</p><p>By default, <a href="https://docs.oracle.com/javase/tutorial/essential/concurrency/atomic.html"><strong>Java guarantees that reading or writing a variable is an atomic operation</strong></a>, unless the variable is a long or double. If the variable is declared as volatile, reads and writes become atomic even if it’s a <code>long</code> or <code>double</code>.</p><p>So, why didn’t our example <code>count++</code> work in the first place? The reason is <code>++</code> decomposes into 3 operations; reading, incrementing, and writing back. Even though they’re atomic by themselves, it doesn’t prevent a thread from reading the variable while the other thread is incrementing it. To overcome this problem, we can use the atomic implementation of the integer primitive: <code>AtomicInteger</code>. It provides atomic versions of some composite operations, such as <code>getAndIncrement()</code>, <code>incrementAndGet()</code> and <code>getAndSet(value)</code>.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thread:%s, counter:%d\\n"</span><span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Here’s the output:</p><pre><code>Thread:t1, counter:0
Thread:t2, counter:1
Thread:t2, counter:3
Thread:t2, counter:4
Thread:t2, counter:5
Thread:t2, counter:6
Thread:t2, counter:7
Thread:t2, counter:8
Thread:t2, counter:9
Thread:t1, counter:2
</code></pre><p>As you can see, even though both of them could enter the while loop, they couldn’t increase the number at the same time. There are atomic implementations of many primitives. You can find them under the <code>java.util.concurrent.atomic</code> package.</p><p>Next time I’ll be talking about <strong>semaphores</strong>, which allows us to have (at most) N number of threads accessing the same shared state at the same time. Have a great day!</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Functional Programming - A Beginner's View]]></title>
            <link>/posts/2017-02-08/functional-programming-a-beginners-view</link>
            <guid>/posts/2017-02-08/functional-programming-a-beginners-view</guid>
            <content:encoded><![CDATA[<div><div><p>For the last couple of weeks, I’ve been trying to learn some functional programming in my free time. For someone who’s never written any functional code before (or, let’s say, in any functional language before), I must say that it was a tough but fun experience.</p><h2 id="first-impression">First Impression</h2><p>I like the structure of Object-Oriented Programming (despite its verbosity), and I like the easiness of using mutable states. These are my tools for a small project. But sometimes, you don’t need things to be easy, but you need them to be <em>reliable</em>.</p><p>Reliability is the magic keyword of functional programming. It gives you (as far as I’ve seen so far) the most reliable code you can get. Whenever your code compiles, you can be sure that it’ll work seamlessly and there won’t be any unexpected results. Let me list you down a couple of reasons why I think that.</p><hr/><img src="data:image/png;base64,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" alt="Immutable"/><h2 id="immutability">Immutability</h2><p>Immutability and pure functions are at the core of functional programming. For the ones who doesn’t know: A <em>pure function</em> is a function that always returns the same thing when you give it the same input. These two concepts make the code incredibly expressive and easy to reason about.</p><p>Think about a function that doubles a number and adds a predefined number to it. Here is a (broken) implementation in C.</p><pre><code class="language-c" data-language="c" data-highlighted-line-numbers=""><span class="token keyword">int</span> x<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">doubleAndAdd10</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  x <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">doubleAndAdd10</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  num <span class="token operator">+=</span> x<span class="token punctuation">;</span>

  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>By only looking at the main function, I expect this program to print 35. But when I run it, I get 30. Although it is the worst code piece I’ve ever written, it shows the main point clearly.</p><p>Mutability starts to become a real problem as your program grows. It makes the code harder to track and reason about. But I don’t think that it is the <em>real evil</em> as others might think. An extreme case of mutability is <em>global mutable state</em>, the one used in the example above, which I think is the real evil.</p><p>Here is the same code in Haskell.</p><pre><code class="language-haskell" data-language="haskell" data-highlighted-line-numbers=""><span class="token hvariable">doubleAndAdd10</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Num</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token hvariable">a</span> <span class="token operator">-></span> <span class="token hvariable">a</span>
<span class="token hvariable">doubleAndAdd10</span> <span class="token hvariable">num</span> <span class="token operator">=</span> <span class="token hvariable">num</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">10</span>

<span class="token hvariable">main</span> <span class="token operator">=</span> <span class="token builtin">print</span> <span class="token operator">$</span> <span class="token hvariable">doubleAndAdd10</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token hvariable">x</span>
  <span class="token keyword">where</span> <span class="token hvariable">x</span> <span class="token operator">=</span> <span class="token number">15</span>
</code></pre><p>It is not only unbreakable; but simpler to write, and easier to read and understand.</p><hr/><img src="/static/media/side-effects.3550b6e6.png" alt="Side effects - XKCD"/><h2 id="side-effects">Side Effects</h2><p>Most of the bugs come from the code pieces that do more than they supposed to do, and that “more” is usually a <em>side effect</em>.</p><p>Side effect means a function modifies the state of something outside of its scope. This might be an AJAX request, printing to console, mutating a global variable (like in the example above - it was the reason of the bug) or whatever you might do to interact with the outside world.</p><p>Side effects are one of the forbidden things in functional programming. When we want our code to be reliable, the first thing we should do is to limit them. The beautiful expressiveness of functional languages lets us know where side effects occur, but this is not enough by itself. We should encapsulate them in small independent functions, and use only those functions to get the desired effect. This way we can be sure about the exact behavior and where it comes from. It’s easier to track down and easier to fix or update.</p><p>Assume we have a <code>Person</code> type which has <code>name</code> and <code>age</code>, and we want to be able to log a <code>Person</code> to console as a string. This is how you write it in JavaScript.</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
      age<span class="token punctuation">:</span> age
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>name <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age
  <span class="token punctuation">}</span>

  <span class="token keyword">set</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token parameter">age</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>age <span class="token operator">=</span> age
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">logPerson</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">person</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> person <span class="token operator">!==</span> <span class="token string">'object'</span> <span class="token operator">||</span> person<span class="token punctuation">.</span>constructor <span class="token operator">!==</span> Person<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`You gave "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> person<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">", it must be a "Person".`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>person<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>This is a lot of code for a very simple task. But being a lot doesn’t make this a quality code, and obviously not a reliable one.</p><p>We monkey check the type of our input. We make use of mutable states (which is not that bad IMO, since we track the state changes with getters and setters). And the worst thing is, without reading this code, no one can be sure that this function doesn’t change an outside state. There is no guarantee that someone won’t change that <code>console.log</code> to another side-effect some day. Moreover, this code is not expressive enough. The other guy who comes after you will have to read all the code to understand what it does. (Or all the comments you wrote, which is more of less the same thing)</p><p>Here comes the functional language. This is the same code in PureScript.</p><pre><code class="language-haskell" data-language="haskell" data-highlighted-line-numbers=""><span class="token keyword">data</span> <span class="token constant">Person</span> <span class="token operator">=</span> <span class="token constant">Person</span> <span class="token punctuation">{</span> <span class="token hvariable">name</span> <span class="token operator">::</span> <span class="token constant">String</span><span class="token punctuation">,</span> <span class="token hvariable">age</span> <span class="token operator">::</span> <span class="token constant">Int</span> <span class="token punctuation">}</span>

<span class="token hvariable">logPerson</span> <span class="token operator">::</span> <span class="token hvariable">forall</span> <span class="token hvariable">t</span><span class="token punctuation">.</span> <span class="token constant">Person</span> <span class="token operator">-></span> <span class="token constant">Eff</span> <span class="token punctuation">(</span> <span class="token string">"console"</span> <span class="token operator">::</span> <span class="token constant">CONSOLE</span> <span class="token operator">|</span> <span class="token hvariable">t</span> <span class="token punctuation">)</span> <span class="token constant">Unit</span>
<span class="token hvariable">logPerson</span> <span class="token punctuation">(</span><span class="token constant">Person</span> <span class="token hvariable">p</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">log</span> <span class="token operator">$</span> <span class="token hvariable">p</span><span class="token punctuation">.</span><span class="token hvariable">name</span> <span class="token operator">&lt;></span> <span class="token string">" "</span> <span class="token operator">&lt;></span> <span class="token builtin">show</span> <span class="token hvariable">p</span><span class="token punctuation">.</span><span class="token hvariable">age</span>
</code></pre><p>These 3 lines have everything that our 31 line JavaScript code does not. It has compile-time type check, and it clearly states that it gets a <code>Person</code> as an input and does a <code>CONSOLE</code> effect.</p><p>You’ll have a very hard time understanding if you’re seeing this for the first time, but don’t worry. It gets only simpler with practice, and actually, it becomes one of the easiest pieces of code to read and understand. (If you want to learn more about PureScript, take a look at <a href="http://leanpub.com/purescript/read">http://leanpub.com/purescript/read</a>)</p><h2 id="composition">Composition</h2><p>This is one of the biggest differences if you are coming from an object-oriented world. Inheritance is <em>top-down</em>, which means you create a general superclass and specialize it as you go down. Sometimes this approach works well, but it becomes very hard to maintain and add new functionalities as your system grows. You start to create more and more general classes to cover all the cases.</p><p>Functional programming works with the <em>bottom-up</em> approach. You start with very simple and tiny functions that do only one thing, and you build on top of them by composing them. It’s easier, and unlike object-oriented programming,  it feels very natural to start with something small and end up with something big.</p><h2 id="compactness">Compactness</h2><p>By composing smaller blocks and making great use of algebraic structures, functional programming pushes you to write very dense and compact code. It feels very hard at first sight, but as I’ve said, it gets only easier.</p><p>Let me give you another basic example, quicksort. This is the implementation in Java.</p><pre><code class="language-java" data-language="java" data-highlighted-line-numbers=""><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">+</span> e<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> pivot <span class="token operator">=</span> arr<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> l <span class="token operator">=</span> s<span class="token punctuation">;</span>
    <span class="token keyword">int</span> r <span class="token operator">=</span> e<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>l<span class="token punctuation">]</span> <span class="token operator">&lt;</span> pivot<span class="token punctuation">)</span> l<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>r<span class="token punctuation">]</span> <span class="token operator">></span> pivot<span class="token punctuation">)</span> r<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;=</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> l<span class="token operator">++</span><span class="token punctuation">,</span> r<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> s<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> l<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> t <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>There are many other implementations, including a functional one which is a little bit shorter, but it’s the overall look of it. Here is the same code in Haskell.</p><pre><code class="language-haskell" data-language="haskell" data-highlighted-line-numbers=""><span class="token hvariable">quicksort</span> <span class="token operator">::</span> <span class="token punctuation">(</span><span class="token constant">Ord</span> <span class="token hvariable">a</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token punctuation">[</span><span class="token hvariable">a</span><span class="token punctuation">]</span>
<span class="token hvariable">quicksort</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token hvariable">quicksort</span> <span class="token punctuation">(</span><span class="token hvariable">x</span><span class="token operator">:</span><span class="token hvariable">xs</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token hvariable">smaller</span> <span class="token operator">++</span> <span class="token punctuation">[</span><span class="token hvariable">x</span><span class="token punctuation">]</span> <span class="token operator">++</span> <span class="token hvariable">bigger</span>
    <span class="token keyword">where</span> <span class="token hvariable">smaller</span> <span class="token operator">=</span> <span class="token hvariable">quicksort</span> <span class="token operator">$</span> <span class="token builtin">filter</span> <span class="token punctuation">(</span><span class="token operator">&lt;=</span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token hvariable">xs</span>
          <span class="token hvariable">bigger</span>  <span class="token operator">=</span> <span class="token hvariable">quicksort</span> <span class="token operator">$</span> <span class="token builtin">filter</span> <span class="token punctuation">(</span><span class="token operator">></span> <span class="token hvariable">x</span><span class="token punctuation">)</span> <span class="token hvariable">xs</span>
</code></pre><p>There are no ambiguous variables, mutable structures, and even need for comments. I think it needs no other explanation.</p><hr/><h2 id="want-more">Want More?</h2><p>There are great articles on functional programming. If you’re planning to try a functional language, I’d advise you to read some of the articles before. If you’re like me, who likes to dive into the language directly, experiment with it and learn it while using it, please don’t try that here. It’ll be very hard. Just learn the basic concepts and the vocabulary before. You’ll thank me later.</p><p>Here are some articles for further reading:</p><ul><li><a href="https://maryrosecook.com/blog/post/a-practical-introduction-to-functional-programming">https://maryrosecook.com/blog/post/a-practical-introduction-to-functional-programming</a></li><li><a href="http://worrydream.com/refs/Hughes-WhyFunctionalProgrammingMatters.pdf">http://worrydream.com/refs/Hughes-WhyFunctionalProgrammingMatters.pdf</a></li><li><a href="http://c2.com/cgi/wiki?AdvantagesOfFunctionalProgramming">http://c2.com/cgi/wiki?AdvantagesOfFunctionalProgramming</a></li><li><a href="http://www.ibm.com/developerworks/library/j-ft20/">http://www.ibm.com/developerworks/library/j-ft20/</a></li></ul><p>More resources for JavaScript: <a href="https://github.com/stoeffel/awesome-fp-js">https://github.com/stoeffel/awesome-fp-js</a></p><p>Here are some functional languages that might better introduce you depending on your current language choice:</p><ul><li>Java: <a href="http://www.scala-lang.org/">Scala</a>, <a href="http://clojure.org/">Clojure</a> (JVM languages).</li><li>JavaScript: <a href="http://www.purescript.org/">PureScript</a>, <a href="http://elm-lang.org/">Elm</a>, <a href="http://himera.herokuapp.com/index.html">ClojureScript</a>.</li><li>Ruby: <a href="http://elixir-lang.org/">Elixir</a>.</li><li>Ruby on Rails: <a href="http://www.phoenixframework.org/">Phoenix</a>.</li><li>C, C++: <a href="https://www.rust-lang.org/">Rust</a>.</li><li>Others: <a href="http://haskell.org/">Haskell</a>, <a href="http://wiki.portal.chalmers.se/agda/pmwiki.php">Agda</a>, <a href="http://www.idris-lang.org/">Idris</a>.</li></ul></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Migrating from Apache/mod_php to Apache/php-fpm]]></title>
            <link>/posts/2017-09-16/migrating-from-mod-php-to-php-fpm</link>
            <guid>/posts/2017-09-16/migrating-from-mod-php-to-php-fpm</guid>
            <content:encoded><![CDATA[<div><div><p>Today is the day. After receiving tons of emails from Jetpack and seeing my server down countless times over the last couple of weeks, I finally made the switch from <code>mod_php</code> to <code>php-fpm</code>.</p><figure><img src="/static/media/img1.e7cadeab.png" alt=""/><figcaption><em>&quot;Your site is extremely slow.&quot;</em></figcaption></figure><figure><img src="/static/media/img2.d3de002c.png" alt=""/><figcaption><em>&quot;Your server is not responding.&quot;</em></figcaption></figure><p>These are basically what I received from Jetpack over and over again. It was totally expected though. My server has the cheapest configuration from DigitalOcean (1 CPU, 512 MB memory) and I host all of my applications on this weak little fella. One of those applications is BOUN Course Planner, which was extremely popular for the last couple of weeks because of the online registration period. It attracted <strong>2000 people per day</strong>, but my little server couldn’t handle that much traffic. Specifically, it couldn’t handle <strong>more than ~30 active connections</strong>.</p><p>I made a small load test and noticed that the Apache processes consume all the memory when there are multiple active connections. The source of the problem was obvious: Apache PHP module, a.k.a. <code>mod_php</code>. It is the module that allows Apache to interpret PHP files, and it’s known to suffer from this kind of memory problems.</p><p>The solution was simple. I removed <code>mod_php</code>, tried to migrate to NGINX with <code>php-fpm</code>, failed (was too lazy to configure the NGINX), migrated to <code>php-fpm</code> only. Here is what I did and what you should do to migrate to <code>php-fpm</code> if you are running Ubuntu 16.04 and using PHP 7.0:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">sudo</span> <span class="token function">apt-get</span> remove libapache2-mod-php7.0 <span class="token comment"># remove mod_php</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> php7.0-fpm libapache2-mod-fastcgi <span class="token comment"># install php-fpm</span>
<span class="token function">sudo</span> a2dismod mpm_worker mpm_prefork <span class="token comment"># disable the conflicting modules</span>
<span class="token function">sudo</span> a2enmod actions fastcgi <span class="token function">alias</span> rewrite mpm_event <span class="token comment"># enable the required modules</span>
</code></pre><p>Add the following configuration to <code>/etc/apache2/conf-available/php7.0-fpm.conf</code>:</p><pre><code>&lt;IfModule mod_fastcgi.c&gt;
    SetHandler php7-fcgi .php
    Action php7-fcgi /php7-fcgi virtual
    Alias /php7-fcgi /usr/lib/cgi-bin/php7-fcgi
    FastCgiExternalServer /usr/lib/cgi-bin/php7-fcgi -socket /var/run/php/php7.0-fpm.sock -pass-header Authorization -idle-timeout 3600
    &lt;Directory /usr/lib/cgi-bin&gt;
        Require all granted
    &lt;/Directory&gt;
&lt;/IfModule&gt;
</code></pre><p>Then enable the configuration and restart the services to see the changes:</p><pre><code>sudo a2enconf php7.0-fpm # enable the php-fpm configuration
service apache2 restart
service php7.0-fpm restart
</code></pre><p>That’s all. You should have your web server up and running with <code>php-fpm</code> now.</p><p>I made some other load tests after the migration, and here are the results:</p><ul><li><strong>Test 1</strong>: 10 to 200 active clients over 1 min (<a href="https://loader.io/reports/c80fb2e2183d2035e8b1f5243a817813/results/3331ea8791f2e237fc4252153fa24fdb">Link to the results</a>)
Response time: 143 ms on average, <strong>276 ms with 200 active connections</strong>.
Error rate: %0.00 (No connection drop, no timeout)</li><li><strong>Test 2</strong>: 10 to 500 active clients over 1 min (<a href="http://loader.io/reports/c80fb2e2183d2035e8b1f5243a817813/results/fdf514b9846a6a66eaf532c7af05093e">Link to the results</a>)
Response time: 350 ms on average, <strong>610 ms with 500 active connections</strong>.
Error rate: %0.00 (No connection drop, no timeout)</li></ul><p>Memory usage during the tests: 52% - 67%. Outcome: <code>php-fpm</code> is clearly better than <code>mod_php</code>.</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Hello Again, World]]></title>
            <link>/posts/2019-05-06/hello-world</link>
            <guid>/posts/2019-05-06/hello-world</guid>
            <content:encoded><![CDATA[<div><div><p>&quot;<em>Hello, World</em>&quot;. When a programmer starts learning a new language, it’s the 2 magical words that must be printed on the screen. I think I have used these words more than I should, I have to stop somewhere but anyways, here is my start.</p><p>I closed my previous blog which was getting a bit messy and built this new one. It’s fully open-source, and you can see the source code <a href="https://github.com/smddzcy/smddzcy.com">here</a>. This blog will be all about programming, tech, and some other mumbo-jumbo. Here I’ll be sharing some of my works, tips &amp; tricks, tutorials.</p><p>I don’t tweet a lot these days, but if you want to talk, click this shiny little twitter link: <strong><a href="http://twitter.com/smddzcy">@smddzcy</a></strong>. You can also send me an e-mail at; samedduzcay @t gmail d0t com. No spam, por favor. Gracias.</p><p>You can share your thoughts about the new design or anything else in the comment box below. Have a great day!</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Deploying a React Application on Azure]]></title>
            <link>/posts/2019-05-13/deploying-react-application-on-azure</link>
            <guid>/posts/2019-05-13/deploying-react-application-on-azure</guid>
            <content:encoded><![CDATA[<div><div><p>Building React apps are super easy now - thanks to tools like <code>create-react-app</code>, but deploying them can still be tricky depending on the platform. I usually use PaaS solutions like <a href="https://www.netlify.com/">Netlify</a> or <a href="https://www.heroku.com/">Heroku</a> to easily deploy my PoC applications with a single command, and use AWS to deploy my production applications. But I was forced to use Azure for my last few projects and it was a bit tricky to use. I’m gonna share <strong>how to deploy a Node + React application on Microsoft Azure</strong> today.</p><h2 id="building-a-react-application">Building a React Application</h2><p>Nowadays, building a React app has become super easy. You don’t have to deal with hundreds of lines of Webpack configuration. You don’t have to think about how to optimize your CSS/JS/images, or your chunks, or anything else. The team behind <code>create-react-app</code> or other tools like <a href="https://nextjs.org/">Next.js</a> or <a href="https://www.gatsbyjs.org/">Gatsby</a> takes care of all of those things for you.</p><p>I usually use <code>create-react-app</code> since I don’t use fancy new stuff like CSS-in-JS (how do you handle caching with this?) or Server-side Rendering (SSR), so I’m going to use that here as well. First, create your app:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers="">create-react-app NewAzureApp
</code></pre><p>We’re going to let Node serve both our React application and the backend API, so let’s add the dependencies for a basic Node API:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">cd</span> NewAzureApp
<span class="token function">yarn</span> <span class="token function">add</span> express body-parser cors helmet morgan
</code></pre><p>Create a file called <code>app.js</code> at the project root:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">touch</span> app.js
</code></pre><p>Then implement a basic API:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token comment">// app.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> helmet <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'helmet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">normalizePort</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> val<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>port <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> port<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">{</span> credentials<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add your API routes under the route `/api`</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> api<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Serve the React application</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'build'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">normalizePort</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`API listening on port: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Now when you build your React application and run <code>app.js</code>, it will automatically serve your app + API together:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">yarn</span> build
node app.js
<span class="token comment"># go to localhost:3000 to see your React app</span>
<span class="token comment"># you can also access your API endpoints from localhost:3000/api</span>
</code></pre><h2 id="deploying-your-application-on-azure">Deploying Your Application on Azure</h2><p>First, you have to create a file called <code>web.config</code> to tell Azure how to run your application. Here’s my <code>web.config</code> that includes the configuration for Node + React + socket.io (I use it quite often).</p><pre><code class="language-xml" data-language="xml" data-highlighted-line-numbers=""><span class="token comment">&lt;!-- web.config --></span>
<span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>system.webServer</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>webSocket</span> <span class="token attr-name">enabled</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>handlers</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>iisnode<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app.js<span class="token punctuation">"</span></span> <span class="token attr-name">verb</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>*<span class="token punctuation">"</span></span> <span class="token attr-name">modules</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>iisnode<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>handlers</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rewrite</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rules</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>StaticContent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>build{PATH_INFO}<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DynamicContent<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/api/*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app.js<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Socket.io polling<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/socket.io/*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app.js<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Socket.io websocket<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/sockjs-node/*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app.js<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>React Routes<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>match</span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>conditions</span> <span class="token attr-name">logicalGrouping</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MatchAll<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{REQUEST_FILENAME}<span class="token punctuation">"</span></span> <span class="token attr-name">matchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IsFile<span class="token punctuation">"</span></span> <span class="token attr-name">negate</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{REQUEST_FILENAME}<span class="token punctuation">"</span></span> <span class="token attr-name">matchType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>IsDirectory<span class="token punctuation">"</span></span> <span class="token attr-name">negate</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>True<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">input</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{REQUEST_URI}<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/api<span class="token punctuation">"</span></span> <span class="token attr-name">negate</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>conditions</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Rewrite<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>build/<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rules</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rewrite</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>security</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>requestFiltering</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hiddenSegments</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>remove</span> <span class="token attr-name">segment</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bin<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hiddenSegments</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>requestFiltering</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>security</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpErrors</span> <span class="token attr-name">existingResponse</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>PassThrough<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>system.webServer</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
</code></pre><p>Now we have a running Node + React app that’s also configured for Azure, it’s time to deploy. Go to Azure and create a <code>Web App</code>.</p><img src="/static/media/azure-webapp.7d59f165.png" title="Azure Web App" class="mb-175"/><p>You have 2 options to deploy your app on Azure:</p><ol><li>Using <a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-ftp">FTP</a></li><li>Using <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/?view=azure-devops">Azure Pipelines</a></li></ol><p>I’m not going to explain the FTP option because it’s pretty straightforward: just upload your whole application using any FTP client to the given server.</p><p>For Azure Pipelines (my preferred way), you have to create an <code>azure-pipelines.yml</code> at the project root. It’s a file that basically tells Azure how to build your application:</p><pre><code class="language-yaml" data-language="yaml" data-highlighted-line-numbers=""><span class="token key atrule">resources</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">repo</span><span class="token punctuation">:</span> self
  <span class="token key atrule">fetchDepth</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token key atrule">pool</span><span class="token punctuation">:</span>
  <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> <span class="token string">'Ubuntu 16.04'</span>

<span class="token key atrule">steps</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> NodeTool@0
  <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
    <span class="token key atrule">versionSpec</span><span class="token punctuation">:</span> <span class="token string">'10.x'</span>
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'Install Node.js'</span>

<span class="token punctuation">-</span> <span class="token key atrule">script</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    npm install
    npm run build</span>
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'npm install and build'</span>

<span class="token punctuation">-</span> <span class="token key atrule">script</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    zip -r result.zip . -x .git/**\* > /dev/null</span>
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'package results'</span>

<span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> PublishBuildArtifacts@1
  <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
    <span class="token key atrule">pathtoPublish</span><span class="token punctuation">:</span> <span class="token string">'$(Build.SourcesDirectory)/result.zip'</span> 
    <span class="token key atrule">artifactName</span><span class="token punctuation">:</span> <span class="token string">'drop'</span> 
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> <span class="token string">'upload artifacts'</span>
</code></pre><p>Now go to your webapp, then go to <code>Deployment Center</code> under <code>Deployment</code> menu, and click <code>Edit</code>. You will be redirected to the Azure Pipelines page, where you will see a tab called <code>Triggers</code>. Go there to create your build triggers, so that your pipeline runs every time you push a commit to a specific branch.</p><p>This is it. After you make another push to your Git remote (e.g. GitHub), your project will be automatically built and deployed. Now you can have a drink and enjoy your Node API + React app on Azure. Let me know if you have any questions, and have a great day.</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Azure Cosmos DB Review]]></title>
            <link>/posts/2019-05-14/azure-cosmos-db-review</link>
            <guid>/posts/2019-05-14/azure-cosmos-db-review</guid>
            <content:encoded><![CDATA[<div><div><p>For those of you who don’t know, <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/introduction">Cosmos DB</a> is a globally distributed database service by Microsoft Azure. It’s easy to use, but in my opinion and experience, it’s really not comparable to AWS DynamoDB or GCP Bigtable when it comes to reliability and speed. It has some serious issues, which I’m going to explain in this blog post.</p><p>I was using (and had to use) Cosmos DB in one of my big projects for the last few months. It was my first time using any Azure tech seriously in a production system, and I can easily say that it wasn’t a pleasurable experience. I was specifically using its Mongo API with Mongoose, and it was a <em>disaster</em>. We had to send many tickets to Microsoft and deal with countless issues ourselves; issues including but not limited to:</p><ol><li><p><code>MongoError: cursor killed or timed out</code><br/><a href="https://social.msdn.microsoft.com/Forums/en-US/7862be04-2396-4679-a5be-72acded1ad16/mongoerror-cursor-does-not-exist-was-killed-or-timed-out?forum=azurecosmosdb">https://social.msdn.microsoft.com/Forums/en-US/7862be04–2396–4679-a5be-72acded1ad16/mongoerror-cursor-does-not-exist-was-killed-or-timed-out?forum=azurecosmosdb</a><br/>Sometimes randomly, sometimes for a big-ish query (returning &gt;1k docs), Cosmos DB was killing Mongo cursors for no specific reason. We tried to solve it ourselves, we failed, then sent a ticket to Microsoft. They made a configuration for our DB and it <em>magically</em> solved the issue. (I still don’t know why Cosmos DB doesn’t come with that <em>magic configuration</em>)</p></li><li><p>Microsoft says (in its official Cosmos DB docs) Mongo API is a <em>fully-supported</em> API, but they don’t officially support any Mongo ORM, including Mongoose. I don’t know how that’s possible; supporting a database API but not others extending that supported API. Get prepared to have <em>lots of</em> issues if you’re planning to use Mongoose with Cosmos DB.</p></li><li><p>Query speed was the biggest issue. We were waiting about a minute to get 10–15k docs with a very simple <code>.find</code> operation.</p><figure><img src="data:image/png;base64,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" title="Terrible Cosmos DB speed"/><figcaption><em>Query for 10k docs with basic filters take 42 seconds</em></figcaption></figure></li></ol><p>Microsoft told us the SQL API is better, and we could solve all of our issues by switching to that. So we decided it’s better to make the switch immediately without growing our codebase any larger. We made the switch with a couple of tricks (which I will explain in my <a href="/posts/2019-05-15/mongooselike-orm-for-azure-cosmos-db-sql-api" title="Mongoose-like ORM for Azure Cosmos DB SQL API" context="[object Object]" class=" ">next post</a>), and actually all the issues above were solved, but then we had many other issues:</p><ol><li><p><strong>Immutable partition-key values</strong><br/>Cosmos DB distributes your data across regions by your provided partition-key field. It’s great, but the problem is, Cosmos DB makes that field <em>immutable</em>. In other words, you can never change the value of a partition-key in any of your documents. In many cases, it forces you to use <code>id</code> as a partition-key, and it results in cross-partition (thus slow) queries.</p></li><li><p><strong>Stateless cross-partition queries</strong><br/>You can’t use <code>OFFSET</code>, <code>LIMIT</code>, <code>TOP</code>, <code>ORDER BY</code>… or any other stateful SQL query on a cross-partition query, e.g. you can’t do pagination if your query spans across many regions (and in many cases it does, because of partition-key value being immutable).</p></li><li><p><strong>Poor <code>JOIN</code> support</strong><br/>Cosmos DB SQL API doesn’t support cross-document joins (i.e. the <code>JOIN</code> you know). It only supports <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/how-to-sql-query#Joins">joining documents with themselves</a>, which makes the whole JOIN operation a joke.</p></li><li><p><strong>Incomplete SQL API</strong><br/>Cosmos DB SQL API is not actually <em>the SQL</em> you know. It’s a subset of SQL with a few additions, which means it’s not as powerful as SQL. One example is that it doesn’t support nested queries.</p></li><li><p><strong>Mysterious auto-indexing</strong><br/>Cosmos DB does the indexing for you, though a bit <em>mysteriously</em>. You can’t specify which fields to index, and you can’t control any part of the process. It’s not exactly an issue, but it’s not something good as well.</p></li><li><p><strong>No partial document update</strong><br/>Not a terrible issue again; but you can’t partially update a document on Cosmos DB. If you want to update a document, you have to provide a whole new document and Cosmos DB replaces the old one with that.</p></li><li><p><strong>No bulk operations</strong><br/>You can’t update/remove many documents at once. It is really not convenient.</p></li></ol><p>The list goes on. Even pagination support (<code>OFFSET</code>/<code>LIMIT</code>) just arrived a few days ago (11 May 2019): <a href="https://feedback.azure.com/forums/263030-azure-cosmos-db/suggestions/6350987--documentdb-allow-paging-skip-take">https://feedback.azure.com/forums/263030-azure-cosmos-db/suggestions/6350987—documentdb-allow-paging-skip-take</a></p><p>But it doesn’t mean that Cosmos DB is <em>all bad</em>. It does have its pros as well, again including but not limited to:</p><ol><li><p><strong>Geo-redundancy with multi-master writes</strong><br/>It’s not an easy problem to solve, and it’s definitely not easy to solve on a global scale. It seems like Cosmos DB solved it pretty well.</p></li><li><p><strong>Multiple API support (SQL, Mongo, Graph..)</strong><br/>Although all APIs are not equally loved by Cosmos DB (as explained above), it does have support for different data modeling needs, which I think is awesome. It makes Cosmos DB very flexible and easy-to-use.</p></li><li><p><strong>High scalability, tunable consistency, global distribution…</strong><br/>It has all the cloud database features you need, and probably more.</p></li></ol><p>All in all, as of writing this blog post, I don’t think Cosmos DB is the best cloud database solution out there. Its Mongo API has serious issues, and its SQL API is not mature/usable enough yet. But I don’t think it’s the worst either. It’s just another option you need to consider depending on your business needs. I still think you should consider other options first though 😉</p><p>Have a great day, and let me know if you have any comments/questions.</p></div></div>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Mongoose-like ORM for Azure Cosmos DB SQL API]]></title>
            <link>/posts/2019-05-15/mongooselike-orm-for-azure-cosmos-db-sql-api</link>
            <guid>/posts/2019-05-15/mongooselike-orm-for-azure-cosmos-db-sql-api</guid>
            <content:encoded><![CDATA[<div><div><p>I talked about <a href="/posts/2019-05-14/azure-cosmos-db-review" title="Cosmos DB review, pros and cons" context="[object Object]" class=" ">pros and cons of Cosmos DB</a> in my previous post, and mentioned that we migrated from Cosmos DB Mongo API to SQL API with a few tricks. I’m going to explain those tricks in this post.</p><p>We had a large codebase (and a few separate small codebases) using Mongoose queries all over and I didn’t want to change all of them to SQL queries. I find SQL queries hard to read/write/maintain, and also plain ugly. For example, a simple Mongoose query like this:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">await</span> Store<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token string">'abc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> sort<span class="token punctuation">:</span> <span class="token punctuation">{</span> referenceNo<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Translates to a huge Cosmos DB SQL query like this:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> querySpec <span class="token operator">=</span> <span class="token punctuation">{</span>
  query<span class="token punctuation">:</span> <span class="token string">'SELECT TOP 1 * FROM stores s WHERE s.code = @code ORDER BY s.referenceNo DESC'</span><span class="token punctuation">,</span>
  parameters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'@code'</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token string">'abc'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// assume that your Cosmos DB container is available at `this.container`</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> result<span class="token punctuation">:</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>querySpec<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre><p>You see the Mongoose query is extremely easy to write and read, while the SQL query requires lots of lines of code and a good SQL knowledge.</p><p>It wasn’t the only issue. Even if I loved SQL and wanted to use it everywhere, we were using lots of Mongoose features like hooks, default values, schema field properties like <code>trim</code> and <code>enum</code>, validations and more. Doing all of these with the SQL API seemed very scary, so I just thought writing my own Mongoose-like ORM for Cosmos DB would be much easier. That way I would keep using the amazing Mongoose API as well, so I did that.</p><h2 id="converting-mongo-queries-to-sql-queries">Converting Mongo Queries to SQL Queries</h2><p>First thing to solve was to convert Mongo queries like <code>.find</code> to SQL queries with <code>SELECT</code>.</p><p>Thankfully, I didn’t have to reinvent the wheel. I found an amazing npm package called <a href="https://www.npmjs.com/package/mongo-sql">mongo-sql</a> that converts Mongo queries to Postgres-style SQL queries, but since Cosmos DB SQL syntax was not exactly <em>SQL</em>, it didn’t work well for many queries. So I made a fork of that and patched/changed some stuff to support Cosmos DB queries, and voila. I had my Mongo-Cosmos query converter ready: <a href="https://github.com/smddzcy/mongo-sql">https://github.com/smddzcy/mongo-sql</a></p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> sqlBuilder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongo-sql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// from https://github.com/smddzcy/mongo-sql#master</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> sqlBuilder<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'select'</span><span class="token punctuation">,</span>
  table<span class="token punctuation">:</span> <span class="token string">'stores'</span><span class="token punctuation">,</span>
  where<span class="token punctuation">:</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token string">'abc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  order<span class="token punctuation">:</span> <span class="token punctuation">{</span> referenceNo<span class="token punctuation">:</span> <span class="token string">'desc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
{ query:
   'select * from stores where stores.code = @p1 order by stores.referenceNo desc',
  values: [ 'abc' ],
  original:
   { type: 'select',
     table: 'stores',
     where: { code: 'abc' },
     order: { referenceNo: 'desc' },
     __defaultTable: 'stores',
     columns: [ '*' ] },
  toString: [Function],
  toQuery: [Function] }
*/</span>
<span class="token keyword">const</span> sqlStr <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// select * from stores where stores.code = @p1 order by stores.referenceNo desc</span>
</code></pre><h2 id="implementing-the-schema-class">Implementing the Schema Class</h2><p>The second and the last thing was implementing a <code>Schema</code> class, just like Mongoose’s, which supports hooks, field properties like <code>enum</code>, <code>default</code>, <code>trim</code>, and some other features.</p><p>I didn’t implement all the features of Mongoose, since it would be meaningless and it would take lots of my time. I implemented a basic <code>Schema</code> class that supports <em>enough</em> of the features - features that I use. It turned out to be very easy and fun to implement. You can find the final <code>Schema</code> class and the other related code <a href="https://gist.github.com/smddzcy/acd58d9fc4ae0bb2102b2c5e36df6ea3">in my public gist</a>, but here’s how it looks like:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token comment">// schema.js</span>
<span class="token keyword">const</span> _ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ioredis'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sqlBuilder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongo-sql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// from https://github.com/smddzcy/mongo-sql#master</span>
<span class="token keyword">const</span> uuid <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> throat <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'throat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> DbError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../error/dbError'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cast <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../cast'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CosmosClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> endpoint<span class="token punctuation">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token string">'...'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> database <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cacheTtl <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> autoAddedFields <span class="token operator">=</span> <span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  _rid<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  _self<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  _etag<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  _attachments<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  _ts<span class="token punctuation">:</span> Number<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Schema</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">schema<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>

  <span class="token function">addHook</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token punctuation">,</span> hook <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">_runHooks</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks
      <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=></span> hook<span class="token punctuation">.</span>type <span class="token operator">===</span> type<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">hook</span> <span class="token operator">=></span> hook<span class="token punctuation">.</span><span class="token function">hook</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> object<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> isRead <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">el</span> <span class="token operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> isRead<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> deleteCache<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> runHooks<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'createdAt'</span> <span class="token keyword">in</span> model<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span>createdAt <span class="token operator">=</span> now<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'updatedAt'</span> <span class="token keyword">in</span> model<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        model<span class="token punctuation">.</span>updatedAt <span class="token operator">=</span> now<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// map defaults etc</span>
    <span class="token keyword">const</span> mappedModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>runHooks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_runHooks</span><span class="token punctuation">(</span><span class="token string">'beforeCreate'</span><span class="token punctuation">,</span> mappedModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>deleteCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_deleteCacheForType</span><span class="token punctuation">(</span><span class="token string">'sql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedModel<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// see: https://github.com/Azure/azure-cosmos-js/issues/241</span>
      mappedModel<span class="token punctuation">.</span>id <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_container<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>mappedModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>

  <span class="token keyword">async</span> <span class="token function">_find</span><span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sql <span class="token operator">=</span> sqlBuilder<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> <span class="token string">'select'</span><span class="token punctuation">,</span>
      table<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>collection<span class="token punctuation">,</span>
      where<span class="token punctuation">:</span> query<span class="token punctuation">,</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sqlStr <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> sql<span class="token punctuation">.</span>values<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`@p</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> cacheLabel <span class="token operator">=</span> sqlStr<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/@(p\d*)/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token string">`'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=></span> v<span class="token punctuation">.</span>name <span class="token operator">===</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// get the docs from cache or db</span>
    <span class="token keyword">const</span> mappedDocs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getFromCacheOrSet</span><span class="token punctuation">(</span><span class="token string">'sql'</span><span class="token punctuation">,</span> cacheLabel<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> querySpec <span class="token operator">=</span> <span class="token punctuation">{</span>
        query<span class="token punctuation">:</span> sqlStr<span class="token punctuation">,</span>
        parameters<span class="token punctuation">:</span> params<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> result<span class="token punctuation">:</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_container<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>querySpec<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enableCrossPartitionQuery<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> items<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// make the populations, if any requested</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>populate <span class="token operator">&amp;&amp;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>populate<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>populate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">field</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>field<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> does not exist in the schema`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">.</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>field<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> does not have a 'ref' field`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Schema<span class="token punctuation">.</span>_registeredModels<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">.</span>ref<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">.</span>ref<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a registered model`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">const</span> model <span class="token operator">=</span> Schema<span class="token punctuation">.</span>_registeredModels<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>schema<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">.</span>ref<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> ids <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">uniq</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span>mappedDocs<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">doc</span> <span class="token operator">=></span> doc<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> docs <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
            ids<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">throat</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token parameter">id</span> <span class="token operator">=></span> model<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> idToDoc <span class="token operator">=</span> ids<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">xs<span class="token punctuation">,</span> x<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            xs<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>docs<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> xs<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          mappedDocs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">mappedDoc</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedDoc<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> idToDoc<span class="token punctuation">[</span>mappedDoc<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              mappedDoc<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">=</span> idToDoc<span class="token punctuation">[</span>mappedDoc<span class="token punctuation">[</span>field<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              mappedDoc<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> mappedDocs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>query <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>options <span class="token operator">||</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// minor optimization</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token parameter">query<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      items <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token operator">...</span>options<span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// single-partition query failed, try cross-partition</span>
      items <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_find</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Schema<span class="token punctuation">;</span>
</code></pre><p>Also here’s how a model looks like:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> Schema <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./schema'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> trim<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  code<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> trim<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  referenceNo<span class="token punctuation">:</span> Number<span class="token punctuation">,</span>
  <span class="token comment">// ... other fields</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  model<span class="token punctuation">:</span> <span class="token string">'Store'</span><span class="token punctuation">,</span>
  collection<span class="token punctuation">:</span> <span class="token string">'stores'</span><span class="token punctuation">,</span>
  partitionKey<span class="token punctuation">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// you can add hooks</span>
Store<span class="token punctuation">.</span><span class="token function">addHook</span><span class="token punctuation">(</span><span class="token string">'beforeCreate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// auto-increment referenceNo</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">await</span> Store<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> order<span class="token punctuation">:</span> <span class="token punctuation">{</span> referenceNo<span class="token punctuation">:</span> <span class="token string">'desc'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  obj<span class="token punctuation">.</span>referenceNo <span class="token operator">=</span> store<span class="token punctuation">.</span>referenceNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Store<span class="token punctuation">;</span>
</code></pre><p>Then I could use Cosmos DB as if I was using Mongoose. All of my queries are automatically turned into SQL queries:</p><pre><code class="language-jsx" data-language="jsx" data-highlighted-line-numbers=""><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">await</span> Store<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token string">'abc'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> order<span class="token punctuation">:</span> <span class="token punctuation">{</span> referenceNo<span class="token punctuation">:</span> <span class="token string">'desc'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SQL query run in the background:</span>
<span class="token comment">// 'select * from stores where stores.code = @p1 order by stores.referenceNo desc'</span>
<span class="token comment">// @p1 parameter = 'abc'</span>
</code></pre><p>I hope this will help you deal with ugly SQL queries and actually enjoy using Cosmos DB. Have a great day!</p></div></div>]]></content:encoded>
        </item>
    </channel>
</rss>