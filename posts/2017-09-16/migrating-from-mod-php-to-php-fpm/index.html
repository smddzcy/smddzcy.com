<!doctype html><html lang="en"><head><meta charset="utf-8"><link rel="shortcut icon" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="theme-color" content="#000000"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="rating" content="General"><link rel="alternate" href="https://smddzcy.com/rss.xml" type="application/rss+xml" title="RSS"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="smddzcy.com"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="author" content="Samed Düzçay"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jvectormap/2.0.4/jquery-jvectormap.min.css"/><link rel="canonical" href="/posts/2017-09-16/migrating-from-mod-php-to-php-fpm" />

    <title data-react-helmet="true">Migrating from Apache/mod_php to Apache/php-fpm</title>
    
    
  <script>window.__NAVI_STATE__={"__navi__":{"requestDataWithoutState":{}}};</script><link href="/static/css/main.19cb9a36.chunk.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"><div class="BlogLayout_container__3WeFl"><div class="
        LoadingIndicator_LoadingIndicator__22gHk
        
        undefined
      "></div><header><h3 class="BlogLayout_title__6OZKV"><a href="/" context="[object Object]" class=" ">smddzcy | yet another dev</a></h3></header><main><article><header class="BlogPostLayout_header__2LB8S"><h1 class="BlogPostLayout_title__3g2FG"><a href="/posts/2017-09-16/migrating-from-mod-php-to-php-fpm" context="[object Object]" class=" ">Migrating from Apache/mod_php to Apache/php-fpm</a></h1><small><time dateTime="Fri, 15 Sep 2017 21:00:00 GMT">September 16, 2017</time> <!-- -->•<!-- --> <ul class="ArticleMeta_tags__VKe_V"><li><a href="/tags/php" context="[object Object]" class=" ">php</a></li><li><a href="/tags/apache" context="[object Object]" class=" ">apache</a></li><li><a href="/tags/mod_php" context="[object Object]" class=" ">mod_php</a></li><li><a href="/tags/php-fpm" context="[object Object]" class=" ">php-fpm</a></li><li><a href="/tags/php7" context="[object Object]" class=" ">php7</a></li></ul> <!-- -->•<!-- --> <span>☕️<!-- --> <!-- -->2<!-- --> min read</span></small></header><div class="BlogPostLayout_content__jzLFq"><div><p>Today is the day. After receiving tons of emails from Jetpack and seeing my server down countless times over the last couple of weeks, I finally made the switch from <code>mod_php</code> to <code>php-fpm</code>.</p><figure><img src="/static/media/img1.e7cadeab.png" alt=""/><figcaption><em>&quot;Your site is extremely slow.&quot;</em></figcaption></figure><figure><img src="/static/media/img2.d3de002c.png" alt=""/><figcaption><em>&quot;Your server is not responding.&quot;</em></figcaption></figure><p>These are basically what I received from Jetpack over and over again. It was totally expected though. My server has the cheapest configuration from DigitalOcean (1 CPU, 512 MB memory) and I host all of my applications on this weak little fella. One of those applications is BOUN Course Planner, which was extremely popular for the last couple of weeks because of the online registration period. It attracted <strong>2000 people per day</strong>, but my little server couldn’t handle that much traffic. Specifically, it couldn’t handle <strong>more than ~30 active connections</strong>.</p><p>I made a small load test and noticed that the Apache processes consume all the memory when there are multiple active connections. The source of the problem was obvious: Apache PHP module, a.k.a. <code>mod_php</code>. It is the module that allows Apache to interpret PHP files, and it’s known to suffer from this kind of memory problems.</p><p>The solution was simple. I removed <code>mod_php</code>, tried to migrate to NGINX with <code>php-fpm</code>, failed (was too lazy to configure the NGINX), migrated to <code>php-fpm</code> only. Here is what I did and what you should do to migrate to <code>php-fpm</code> if you are running Ubuntu 16.04 and using PHP 7.0:</p><pre><code class="language-bash" data-language="bash" data-highlighted-line-numbers=""><span class="token function">sudo</span> <span class="token function">apt-get</span> remove libapache2-mod-php7.0 <span class="token comment"># remove mod_php</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> php7.0-fpm libapache2-mod-fastcgi <span class="token comment"># install php-fpm</span>
<span class="token function">sudo</span> a2dismod mpm_worker mpm_prefork <span class="token comment"># disable the conflicting modules</span>
<span class="token function">sudo</span> a2enmod actions fastcgi <span class="token function">alias</span> rewrite mpm_event <span class="token comment"># enable the required modules</span>
</code></pre><p>Add the following configuration to <code>/etc/apache2/conf-available/php7.0-fpm.conf</code>:</p><pre><code>&lt;IfModule mod_fastcgi.c&gt;
    SetHandler php7-fcgi .php
    Action php7-fcgi /php7-fcgi virtual
    Alias /php7-fcgi /usr/lib/cgi-bin/php7-fcgi
    FastCgiExternalServer /usr/lib/cgi-bin/php7-fcgi -socket /var/run/php/php7.0-fpm.sock -pass-header Authorization -idle-timeout 3600
    &lt;Directory /usr/lib/cgi-bin&gt;
        Require all granted
    &lt;/Directory&gt;
&lt;/IfModule&gt;
</code></pre><p>Then enable the configuration and restart the services to see the changes:</p><pre><code>sudo a2enconf php7.0-fpm # enable the php-fpm configuration
service apache2 restart
service php7.0-fpm restart
</code></pre><p>That’s all. You should have your web server up and running with <code>php-fpm</code> now.</p><p>I made some other load tests after the migration, and here are the results:</p><ul><li><strong>Test 1</strong>: 10 to 200 active clients over 1 min (<a href="https://loader.io/reports/c80fb2e2183d2035e8b1f5243a817813/results/3331ea8791f2e237fc4252153fa24fdb" rel="nofollow noopener noreferrer" target="_blank" context="[object Object]" class=" ">Link to the results</a>)
Response time: 143 ms on average, <strong>276 ms with 200 active connections</strong>.
Error rate: %0.00 (No connection drop, no timeout)</li><li><strong>Test 2</strong>: 10 to 500 active clients over 1 min (<a href="http://loader.io/reports/c80fb2e2183d2035e8b1f5243a817813/results/fdf514b9846a6a66eaf532c7af05093e" rel="nofollow noopener noreferrer" target="_blank" context="[object Object]" class=" ">Link to the results</a>)
Response time: 350 ms on average, <strong>610 ms with 500 active connections</strong>.
Error rate: %0.00 (No connection drop, no timeout)</li></ul><p>Memory usage during the tests: 52% - 67%. Outcome: <code>php-fpm</code> is clearly better than <code>mod_php</code>.</p></div></div><div style="margin-top:3rem"><div id="disqus_thread"></div></div><footer class="BlogPostLayout_footer__2aOsZ"><h3 class="BlogPostLayout_title__3g2FG"><a href="/" context="[object Object]" class=" ">smddzcy | yet another dev</a></h3><div class="
      Bio_Bio__3ifbk
      BlogPostLayout_bio__3d60S
    "><img src="https://pbs.twimg.com/profile_images/781276128673689600/tGOdd3qK_400x400.jpg" alt="Me"/><div><div>personal blog of <a href="https://twitter.com/smddzcy" title="Twitter" rel="nofollow noopener noreferrer" target="_blank">Samed Düzçay</a>.<br/>software engineer, web enthusiast. shares articles, tutorials and his thoughts on various things.</div><div><a href="https://linkedin.com/in/smddzcy" title="LinkedIn" rel="nofollow noopener noreferrer" target="_blank" style="margin-right:5px">LinkedIn</a>•<a href="https://github.com/smddzcy" title="GitHub" rel="nofollow noopener noreferrer" target="_blank" style="margin:0 5px">GitHub</a>•<a href="https://twitter.com/smddzcy" title="Twitter" rel="nofollow noopener noreferrer" target="_blank" style="margin:0 5px">Twitter</a>•<a href="/cv" title="CV" style="margin:0 5px">CV</a></div></div></div><section class="BlogPostLayout_links__2NwEx"><a class=" " href="/posts/2019-05-06/hello-world" context="[object Object]">← <!-- -->Hello Again, World</a><a class="BlogPostLayout_next__3Rs3G " href="/posts/2017-02-08/functional-programming-a-beginners-view" context="[object Object]">Functional Programming - A Beginner&#x27;s View<!-- --> →</a></section></footer></article></main></div></div><script>!function(d){function e(e){for(var t,r,n=e[0],c=e[1],o=e[2],f=0,a=[];f<n.length;f++)r=n[f],l[r]&&a.push(l[r][0]),l[r]=0;for(t in c)Object.prototype.hasOwnProperty.call(c,t)&&(d[t]=c[t]);for(p&&p(e);a.length;)a.shift()();return i.push.apply(i,o||[]),u()}function u(){for(var e,t=0;t<i.length;t++){for(var r=i[t],n=!0,c=1;c<r.length;c++){var o=r[c];0!==l[o]&&(n=!1)}n&&(i.splice(t--,1),e=s(s.s=r[0]))}return e}var r={},a={30:0},l={30:0},i=[];function s(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return d[e].call(t.exports,t,t.exports,s),t.l=!0,t.exports}s.e=function(i){var e=[];a[i]?e.push(a[i]):0!==a[i]&&{1:1,15:1,16:1}[i]&&e.push(a[i]=new Promise(function(e,n){for(var t="static/css/"+({}[i]||i)+"."+{1:"c7066986",2:"31d6cfe0",3:"31d6cfe0",4:"31d6cfe0",5:"31d6cfe0",6:"31d6cfe0",7:"31d6cfe0",8:"31d6cfe0",9:"31d6cfe0",10:"31d6cfe0",11:"31d6cfe0",12:"31d6cfe0",13:"31d6cfe0",14:"31d6cfe0",15:"5495e4c2",16:"1eee5681",17:"31d6cfe0",18:"31d6cfe0",19:"31d6cfe0",20:"31d6cfe0",21:"31d6cfe0",22:"31d6cfe0",23:"31d6cfe0",24:"31d6cfe0",25:"31d6cfe0",26:"31d6cfe0",27:"31d6cfe0",29:"31d6cfe0"}[i]+".chunk.css",c=s.p+t,r=document.getElementsByTagName("link"),o=0;o<r.length;o++){var f=(d=r[o]).getAttribute("data-href")||d.getAttribute("href");if("stylesheet"===d.rel&&(f===t||f===c))return e()}var a=document.getElementsByTagName("style");for(o=0;o<a.length;o++){var d;if((f=(d=a[o]).getAttribute("data-href"))===t||f===c)return e()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=e,u.onerror=function(e){var t=e&&e.target&&e.target.src||c,r=new Error("Loading CSS chunk "+i+" failed.\n("+t+")");r.request=t,n(r)},u.href=c,document.getElementsByTagName("head")[0].appendChild(u)}).then(function(){a[i]=0}));var r=l[i];if(0!==r)if(r)e.push(r[2]);else{var t=new Promise(function(e,t){r=l[i]=[e,t]});e.push(r[2]=t);var n,c=document.getElementsByTagName("head")[0],o=document.createElement("script");o.charset="utf-8",o.timeout=120,s.nc&&o.setAttribute("nonce",s.nc),o.src=s.p+"static/js/"+({}[i]||i)+"."+{1:"13641dd6",2:"1daad283",3:"9063ce51",4:"88c40bf3",5:"43ffdecf",6:"880bfbe7",7:"bfa6213f",8:"1edc00a8",9:"9b23b94d",10:"450bcd83",11:"54c552fb",12:"bab4e784",13:"6c746bf8",14:"492a0d16",15:"db4dd887",16:"4c1a9d73",17:"dd209414",18:"82e3987f",19:"f3b1ca76",20:"390aacdf",21:"752a4269",22:"9713d4c7",23:"b52480fb",24:"e2ac1d6c",25:"ffa21eb4",26:"5efab3ad",27:"fb21620e",29:"7be75133"}[i]+".chunk.js",n=function(e){o.onerror=o.onload=null,clearTimeout(f);var t=l[i];if(0!==t){if(t){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,c=new Error("Loading chunk "+i+" failed.\n("+r+": "+n+")");c.type=r,c.request=n,t[1](c)}l[i]=void 0}};var f=setTimeout(function(){n({type:"timeout",target:o})},12e4);o.onerror=o.onload=n,c.appendChild(o)}return Promise.all(e)},s.m=d,s.c=r,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s.oe=function(e){throw console.error(e),e};var t=window.webpackJsonp=window.webpackJsonp||[],n=t.push.bind(t);t.push=e,t=t.slice();for(var c=0;c<t.length;c++)e(t[c]);var p=n;u()}([])</script><script src="/static/js/28.99536fac.chunk.js"></script><script src="/static/js/main.faf97013.chunk.js"></script></body></html>